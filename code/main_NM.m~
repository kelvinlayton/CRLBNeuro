% This code repricates the structure of the Voss / Schiff FN simulation /
% estimation

%%
clc
close all
clear

params.dt = 0.0001;

params.e0 = 2.5;
params.r = 0.56;
params.v0 = 6;

params.a = 100;
params.b = 50;

params.A = 3.25;
params.B = 22;


params.mu = 11;        % mean input mem potential.



N = 50000;             	% number of samples
dT = params.dt;          	% sampling time step (global)
dt = 1*dT;            	% integration time step
nn = fix(dT/dt);      	% (used in for loop for forward modelling) the integration time step can be small that the sampling (fix round towards zero)
t = 0:dt:(N-1)*dt;



% Transition model
NStates = 4;                           
f = @(x)NM_Model(x,params);

% Initialise trajectory state
x0 = zeros(NStates,1);                   % initial state
x = zeros(NStates,N); 
x(:,1) = x0;





% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% Generate trajectory
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

% Euler integration
%
for n=1:N-1
    x(:,n+1) = f(x(:,n));
end

H = [1 0 0 0];           % observation function

figure
plot(H*x)

Q = zeros(NStates);
for n=1:NStates
    Q(n,n) = (0.4*std(x(n,:))*sqrt(dt))^2;
end
% Initialise random number generator for repeatability
rng(0);
v = mvnrnd(zeros(NStates,1),Q,N)';

% Euler-Maruyama integration
for n=1:N-1
    x(:,n+1) = f(x(:,n)) + v(:,n);
end

R = 1^2*eye(1);
w = mvnrnd(zeros(size(H,1),1),R,N)';
y = H*x + w;

figure
plot(y)
drawnow


%%

% initalise state estimate
x_hat = zeros(size(x));
x_hat(:,1) = mean(x(:,round(N/2):end),2);

P = diag(var(x(:,round(N/2):end),0,2));

figure
n=1;
subplot(421),plot(x_hat(n,1) + sqrt(P(n,n))*randn(1,N)),ylim([-50,50])
subplot(422),plot(x(n,:)),ylim([-50,50])

n=2;
subplot(423),plot(x_hat(n,1) + sqrt(P(n,n))*randn(1,N)),ylim([-1500,1500])
subplot(424),plot(x(n,:)),ylim([-1500,1500])

n=3;
subplot(425),plot(x_hat(n,1) + sqrt(P(n,n))*randn(1,N)),ylim([-20,20])
subplot(426),plot(x(n,:)),ylim([-20,20])

n=4;
subplot(427),plot(x_hat(n,1) + sqrt(P(n,n))*randn(1,N)),ylim([-1000,1000])
subplot(428),plot(x(n,:)),ylim([-1000,1000])